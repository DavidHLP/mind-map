# 什么是Java中的不可变类

* 回答重点

  * **不可变类**：创建后其状态（对象的字段）无法被修改的类；对象一旦创建，所有属性在整个生命周期内保持不变
  * **关键特征**

    1. 将类声明为 `final`，防止子类继承
    2. 所有字段均为 `private` 且 `final`，确保初始化后不可更改
    3. 通过构造函数初始化所有字段
    4. 不提供任何修改对象状态的方法（如 `setter`）
    5. 若包含可变对象引用，需防止外部修改：如在 getter 中返回**副本**（新建对象）
  * **经典不可变类**：`String`、`Integer`、`BigDecimal`、`LocalDate` 等

* 扩展知识

  * 不可变类的优缺点

    * **优点**

      1. **线程安全**：状态不可变，天生线程安全，无需同步
      2. **缓存友好**：可安全缓存与共享，如 `String` 常量池
      3. **防止状态不一致**：避免因意外修改导致的不一致
    * **缺点**

      1. **性能问题**：每次“修改”需新建对象；大对象或高频修改场景（如字符串频繁拼接）可能有开销

* 举例 String

  * `String` 是典型的不可变类：对象创建后无法修改
  * 表达式 `s += "a";` 会**新建**一个 `String`，原对象不变，仅引用 `s` 指向新对象
  * 因此**避免**在频繁拼接场景使用 `+`，以免频繁创建对象
  * 不可变带来**安全性**与**并发友好**
  * 设计要点展示

    * `String` 用 `final` 修饰，表示无法被继承
      ![image-20210228112501169](https://pic.code-nav.cn/mianshiya/question_picture/1772087337535152129/image-20210228112501169_mianshiya.png)
    * `String` 本质是 `char` 数组并用 `final` 修饰；同时 `value` 为 `private` 且**无 setter**，外部无法直接修改
    * 需要“修改”行为（如 `replace`）时，**返回新对象**
      ![image-20210228112521363](https://pic.code-nav.cn/mianshiya/question_picture/1772087337535152129/image-20210228112521363_mianshiya.png)

* 如何实现一个不可变类？

  - 按“关键特征”执行：类 `final`；字段 `private final`；构造器完全初始化；不暴露可变状态；若包含可变字段在对外暴露时返回**防御性拷贝**
  - **总结**：私有化变量 + 不暴露 `set` 方法；即使有“修改”需求，也**返回新对象**
  - 集合用 List.copyOf/Set.copyOf（优先）或 Collections.unmodifiableXXX 包装不可变集合
  - Java 16 可以使用 record 简化不可变类的创建
