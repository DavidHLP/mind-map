# MySQL 中长事务可能导致的问题

## 1. 长时间锁竞争，阻塞资源

- 长事务持有锁时间长，其他事务尝试获取锁时会阻塞
- 系统等待时间增加，并发性能下降
- 业务线程可能阻塞，影响其他服务，严重情况下可能引发雪崩和线上事故

---

## 2. 死锁风险

- 多个长事务互相等待对方释放锁
- 容易产生死锁，导致系统无法继续执行

---

## 3. 主从延迟

- 主库执行长事务，向从库传输数据时延迟明显
- 从库重放事务需要很长时间，数据在一定时间内不同步

---

## 4. 回滚造成时间浪费

- 长事务执行时间长，若中途出错回滚
- 已完成的操作全部被撤销，浪费大量时间和资源

---

## 5. 解决方案

1. **拆分长事务**
   - 将大事务拆成小事务，同时执行，提高效率
2. **建立索引**
   - 为查询或修改的字段建立索引，减少扫描和锁竞争
3. **转换思路**
   - 删除大量数据可以通过：
     - 将剩余数据插入新表
     - 最后删除旧表
   - 避免一次性大事务操作

---

## 面试速记

- **Q1: 长事务可能导致什么问题？**
  - 锁竞争阻塞、死锁、主从延迟、回滚浪费时间
- **Q2: 为什么长事务容易死锁？**
  - 多个事务互相等待释放锁
- **Q3: 主从延迟与长事务的关系？**
  - 主库执行长事务，从库重放慢，数据短时间不同步
- **Q4: 如何优化长事务？**
  - 拆分事务、建立索引、转换操作思路
