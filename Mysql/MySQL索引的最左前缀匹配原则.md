# MySQL 联合索引最左前缀匹配原则

## 1. 底层原理

- 联合索引在 **B+ 树中按照列顺序排列**
- 例如索引 `(first_name, last_name, age)`：
  - B+ 树按照 **first_name → last_name → age** 的顺序存储
  - 数据在树中的排序严格遵循这个顺序

---

## 2. 最左前缀匹配原则

- 联合索引必须 **从最左列开始依次匹配**，才能正确使用索引
- 如果没有按照最左列顺序使用索引，可能会导致索引失效

---

## 3. 索引可能失效的情况

### (1) 无界范围匹配停止

- 范围查询 (`>`, `<`) 会 **停止后续列匹配**
- 例如：

```sql
WHERE a > 1 AND b = 2 AND c = 3;
```

- B+ 树使用索引匹配 a 后，b 和 c 数据无序，因此无法利用索引查找
- 注意：

  - `>=`, `<=`, `BETWEEN`, 前缀 `LIKE 'xx%'` 不会完全停止匹配

```sql
WHERE a >= 1 AND b = 2 AND c = 3;
```

- 可以先定位 a 的起始位置，再顺序扫描 b、c

---

### (2) 左模糊匹配或全模糊匹配

- `LIKE '%xx'` 或 `LIKE '%xx%'` **索引失效**
- 原因：无法直接定位 B+ 树节点，需要全表扫描

---

### (3) 对索引列做计算或函数操作

- 例如：

```sql
WHERE YEAR(create_time) = 2025
```

- 计算后的结果无法直接利用 B+ 树的原始值匹配索引
- 类型转换或隐式转换也会导致失效

---

### (4) OR 条件不当

- 如果 OR 两边条件列不同，只有一边有索引：

```sql
WHERE name = '张三' OR create_time = '2025-08-08';
```

- 索引无法利用，MySQL 可能执行全表扫描

---

## 面试速记

- 联合索引 **必须从最左列开始使用**
- 范围查询会停止后续列匹配
- 左模糊 `%xx`、函数操作、类型转换都会导致索引失效
- OR 查询两边列不同，索引失效
- 熟记 B+ 树按列顺序存储顺序，便于理解最左匹配原则
