---
markmap:
  colorFreezeLevel: 2
---

# MySQL 中 SQL 语句执行过程

---

## 1. Server 层

### 1.1 连接器 (Connector)

**面试要点：**

- 建立连接、管理连接、校验用户身份。

**详细信息：**

- TCP 连接建立后，验证用户名和密码。
- 空闲连接最大时间由 `wait_timeout` 控制（默认 8 小时）。
- 超过空闲时长，连接器会自动断开连接。

---

### 1.2 查询缓存 (Query Cache)

**面试要点：**

- 命中缓存直接返回结果，未命中则继续执行。
- **注意：MySQL 8.0 已移除查询缓存模块。**

**详细信息：**

- 查询缓存与 InnoDB Buffer Pool 不同。
- 缓存以 SQL 语句为 key，查询结果为 value。

---

### 1.3 解析 SQL

**模块：** 解析器 (Parser)

**面试要点：**

- 构建语法树，方便后续模块获取 SQL 类型、表名、字段名及条件。

**详细信息：**

- **词法分析：** 识别关键字和标记 (Token)。
- **语法分析：** 判断语法合法性，生成 SQL 语法树。

---

### 1.4 执行 SQL

#### 1.4.1 预处理器 (Prepare)

**面试要点：**

- 检查表和字段是否存在。
- 展开 `SELECT *` 为表的所有列。

#### 1.4.2 优化器 (Optimizer)

**面试要点：**

- 选择最佳执行计划。
- 决定使用哪个索引以最小化 CPU 和 I/O 成本。

**详细信息：**

- 多索引时，优化器会计算成本并选择最优方案。
- 索引过多可能导致优化器耗时增加，甚至选择次优索引。

#### 1.4.3 执行器 (Executor)

**面试要点：**

- 按执行计划访问存储引擎，读取数据并返回结果。

**详细信息：**

- **主键查询：**
  - 如 `SELECT * FROM product WHERE id = 1;`
  - 使用 `const` 类型访问，直接定位记录。
- **全表扫描：**
  - 如 `SELECT * FROM product WHERE name = 'iphone';`
  - 使用 `ALL` 类型访问，全表扫描。
- **索引下推 (Index Condition Pushdown)：**
  - 部分 `WHERE` 条件下推到存储引擎层过滤，减少回表次数。

---

## 2. 存储引擎层

**主要存储引擎：**

- InnoDB
- MyISAM
- 其他自定义存储引擎

**作用：**

- 负责数据的实际存储和提取。
- 与文件系统交互，提供事务、索引、锁等功能（以 InnoDB 为例）。

---

## 面试速记

- **SQL 执行顺序：**
  1. 连接器建立连接
  2. 查询缓存（已废弃 MySQL 8.0）
  3. SQL 解析（词法分析 + 语法分析）
  4. 预处理器检查表字段
  5. 优化器选择执行计划
  6. 执行器执行计划访问存储引擎
- **优化器作用：** 选择最优索引，降低 CPU/I/O 成本
- **执行器作用：** 遍历索引或全表，读取数据，返回结果
- **索引下推：** 优化器 + 执行器协作，减少回表
